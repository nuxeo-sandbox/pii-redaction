<!--
`piir-dlp-view`
@group Nuxeo UI
@element piir-dlp-view
-->
<dom-module id="piir-dlp-view">
  <template>
    <style include="nuxeo-styles">
      /* Make it fit on the page, no vertical scrollbar */
      .results {
        height: calc(100vh - 345px - var(--nuxeo-app-top));
      }
    </style>

    <template is="dom-if"
              if="[[_hasDLP(document)]]">

      <div role="widget"
           hidden$="[[!document.properties.dlp:scanDate]]">
        <label>[[i18n('piir.label.dlpview.date')]]</label>
        <nuxeo-date datetime="[[document.properties.dlp:scanDate]]"
                    name="scanDate">
        </nuxeo-date>
      </div>

      <div role="widget">
        <label>[[i18n('piir.label.dlpview.status')]]</label>
        <div name="scanStatus">[[document.properties.dlp:scanStatus]]</div>
      </div>

      <div role="widget">
        <label>[[i18n('piir.label.dlpview.flag')]]</label>
        <paper-checkbox checked="[[document.properties.dlp:sensitiveData]]"
                        disabled="true"
                        name="sensitiveData">
        </paper-checkbox>
      </div>

      <div role="widget">
        <label>[[i18n('piir.label.dlpview.findings')]]</label>


        <nuxeo-data-table role="widget"
                          class="results"
                          items="{{document.properties.dlp:findings}}"
                          name="changeLog">

          <nuxeo-data-table-column name="[[i18n('piir.label.dlpview.infotype')]]">
            <template>
              <nuxeo-tag>[[item.type]]</nuxeo-tag>
            </template>
          </nuxeo-data-table-column>

          <nuxeo-data-table-column name="[[i18n('piir.label.dlpview.score')]]">
            <template>
              <nuxeo-tag>[[item.score]]</nuxeo-tag>
            </template>
          </nuxeo-data-table-column>

          <nuxeo-data-table-column name="[[i18n('piir.label.dlpview.value')]]">
            <template>
              [[item.info]]
            </template>
          </nuxeo-data-table-column>

          <nuxeo-data-table-column name="[[i18n('piir.label.dlpview.location')]]">
            <template>
              [[_formatLocationAsText(item.locationJson)]]
            </template>
          </nuxeo-data-table-column>

        </nuxeo-data-table>

      </div>

    </template>

  </template>

  <script>
    Polymer({
      is: 'piir-dlp-view',
      behaviors: [Nuxeo.LayoutBehavior],
      properties: {
        document: {
          type: Object
        }
      },

      _hasDLP: function (doc) {
        return this.hasFacet(doc, "DataLossPrevention");
      },

      _formatLocationAsText: function (locationJsonStr) {
        try {
          let txt = "";
          let json = JSON.parse(locationJsonStr);
          if (json.hasImageLocation) {
            txt += "\n    image Location, ";
            txt += json.firstImageLocation.top + "-" + json.firstImageLocation.left;
            txt += " (" + json.firstImageLocation.width + "x" + json.firstImageLocation.height + ")";
          }

          if (json.hasByteRange) {
            txt += "\n    Byte Range, start " + json.byteRange.start + ", end " + json.byteRange.end;
          }

          if (json.hasCodepointRange) {
            txt += "\n    Codepoint Range, start " + json.codePointRange.start + ", end " + json.codePointRange.end;
          }

          return txt;
        } catch (err) {
          console.error("Error parsing the location: " + err);
        }

        return locationJsonStr;
      }

    });
  </script>
</dom-module>